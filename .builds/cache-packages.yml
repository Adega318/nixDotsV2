image: nixos/unstable

packages:
  - nixos.nixUnstable
  - nixos.cachix

environment:
  NIX_CONFIG: "experimental-features = nix-command flakes"

secrets:
  - f2907d38-97b4-4e7d-9fb9-57b3fb0135af

tasks:
- setup_cachix: |
    cat ~/.cachix_token | cachix authtoken --stdin
    cachix use misterio
- build: |
    cd nix-config

    # Build alacritty with ligatures
    nix build .#alacritty-ligatures -o result-alacritty

    # Build all gtk themes
    schemes=$(nix eval --raw .#generated-gtk-themes --apply 's: builtins.concatStringsSep "," (builtins.attrNames s)')
    gtk_themes=$(eval echo .#generated-gtk-themes.{$schemes})
    nix build $gtk_themes -o result-gtk-themes
- upload_cachix: |
    nix path-info nix-config/result*/ -r | cachix push misterio
